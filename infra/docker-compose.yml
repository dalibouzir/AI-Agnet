# For M1, keep resources low; increase if needed.

services:
  db:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama:/root/.ollama
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
      MINIO_PROMETHEUS_AUTH_TYPE: public
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

  opensearch:
    image: opensearchproject/opensearch:2.13.0
    environment:
      discovery.type: single-node
      plugins.security.disabled: "true"
      compatibility.override_main_response_version: "true"
      DISABLE_INSTALL_DEMO_CONFIG: "true"
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: ${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-adminadmin}
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9600:9600"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    # Health check authenticates so it still passes if the security plugin is enabled later.
    healthcheck:
      test: ["CMD-SHELL", "curl -fsSL -u admin:$$OPENSEARCH_INITIAL_ADMIN_PASSWORD http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
    volumes:
      - opensearch-data:/usr/share/opensearch/data

  opensearch-dashboards:
    profiles: ["observability"]
    image: opensearchproject/opensearch-dashboards:2.13.0
    environment:
      OPENSEARCH_HOSTS: '["http://opensearch:9200"]'
      DISABLE_SECURITY_DASHBOARDS_PLUGIN: "true"
    depends_on:
      opensearch:
        condition: service_healthy
    ports:
      - "5601:5601"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5601/api/status"]
      interval: 15s
      timeout: 5s
      retries: 20

  nats:
    image: nats:2.10-alpine
    ports:
      - "4222:4222"
      - "8222:8222"

  prometheus:
    profiles: ["observability"]
    image: prom/prometheus:latest
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  grafana:
    profiles: ["observability"]
    image: grafana/grafana:latest
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/var/lib/grafana/dashboards
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3002:3000"
    depends_on:
      - prometheus

  redis-exporter:
    profiles: ["observability"]
    image: oliver006/redis_exporter:latest
    command: ["--redis.addr=redis:6379"]
    depends_on:
      - redis
    ports:
      - "9121:9121"

  postgres-exporter:
    profiles: ["observability"]
    image: prometheuscommunity/postgres-exporter
    environment:
      DATA_SOURCE_NAME: 'postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}?sslmode=disable'
    depends_on:
      - db
    ports:
      - "9187:9187"

  opensearch-exporter:
    profiles: ["observability"]
    image: docker.io/prometheuscommunity/elasticsearch-exporter:v1.7.0
    command: ['--es.uri=http://opensearch:9200']
    depends_on:
      opensearch:
        condition: service_healthy
    ports:
      - "9114:9114"

  traefik:
    profiles: ["observability"]
    image: traefik:v3.1
    command:
      - --providers.file.filename=/etc/traefik/traefik.yml
      - --entrypoints.web.address=:80
    ports:
      - "80:80"
    volumes:
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro

  data-tunnel:
    build:
      context: ..
      dockerfile: services/data-tunnel/Dockerfile
    env_file:
      - ../.env
    environment:
      ENABLE_OCR: "true"
      OCR_LANGS: "eng+fra"
      PARSERS: "pdf,docx,txt,csv,pptx,xlsx,image,json"
    depends_on:
      db:
        condition: service_started
      redis:
        condition: service_started
      minio:
        condition: service_started
      opensearch:
        condition: service_healthy
      nats:
        condition: service_started
    ports:
      - "8006:8000"

  data-tunnel-worker:
    profiles: ["ingest-worker"]
    build:
      context: ..
      dockerfile: services/data-tunnel/Dockerfile
    command: celery -A celery_app.celery worker --loglevel=info
    env_file:
      - ../.env
    environment:
      ENABLE_OCR: "true"
      OCR_LANGS: "eng+fra"
      PARSERS: "pdf,docx,txt,csv,pptx,xlsx,image,json"
      EMBEDDING_BACKEND: ${EMBEDDING_BACKEND:-ollama}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-nomic-embed-text}
      EMBEDDING_OLLAMA_URL: ${EMBEDDING_OLLAMA_URL:-http://ollama:11434}
      TENANT_NAMESPACE: ${TENANT_NAMESPACE:-tenant-demo}
      OPENSEARCH_HOST: ${OPENSEARCH_HOST:-infra-opensearch-1}
      OPENSEARCH_PORT: ${OPENSEARCH_PORT:-9200}
    depends_on:
      - data-tunnel
      - redis
      - db
      - ollama
    restart: unless-stopped

  data-tunnel-worker-parallel:
    profiles: ["ingest-worker"]
    build:
      context: ..
      dockerfile: services/data-tunnel/Dockerfile
    command: celery -A celery_app.celery worker --loglevel=info
    env_file:
      - ../.env
    environment:
      ENABLE_OCR: "true"
      OCR_LANGS: "eng+fra"
      PARSERS: "pdf,docx,txt,csv,pptx,xlsx,image,json"
      EMBEDDING_BACKEND: ${EMBEDDING_BACKEND:-ollama}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-nomic-embed-text}
      EMBEDDING_OLLAMA_URL: ${EMBEDDING_OLLAMA_URL:-http://ollama:11434}
      TENANT_NAMESPACE: ${TENANT_NAMESPACE:-tenant-demo}
      OPENSEARCH_HOST: ${OPENSEARCH_HOST:-infra-opensearch-1}
      OPENSEARCH_PORT: ${OPENSEARCH_PORT:-9200}
    depends_on:
      - data-tunnel
      - redis
      - db
      - ollama
    restart: unless-stopped

  orchestrator:
    build:
      context: ..
      dockerfile: services/orchestrator/Dockerfile
    env_file:
      - ../.env
    depends_on:
      rag:
        condition: service_started
    ports:
      - "8001:8000"

  rag:
    build:
      context: ..
      dockerfile: services/rag/Dockerfile
    env_file:
      - ../.env
    environment:
      EMBEDDING_BACKEND: ${EMBEDDING_BACKEND:-ollama}
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-nomic-embed-text}
      EMBEDDING_OLLAMA_URL: ${EMBEDDING_OLLAMA_URL:-http://ollama:11434}
      TENANT_NAMESPACE: ${TENANT_NAMESPACE:-tenant-demo}
      OPENSEARCH_HOST: ${OPENSEARCH_HOST:-infra-opensearch-1}
      OPENSEARCH_PORT: ${OPENSEARCH_PORT:-9200}
    depends_on:
      opensearch:
        condition: service_healthy
      minio:
        condition: service_started
      llm-api:
        condition: service_started
    ports:
      - "8002:8000"

  llm-api:
    build:
      context: ..
      dockerfile: services/llm_api/Dockerfile
    env_file:
      - ../.env
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-ft:gpt-4o-mini-2024-07-18:esprit:ai-business-agent-v1:CaIy8Jh2}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      LLM_PROVIDER: ${LLM_PROVIDER:-openai}
      MODEL_NAME: ${MODEL_NAME:-ft:gpt-4o-mini-2024-07-18:esprit:ai-business-agent-v1:CaIy8Jh2}
      PROFILE: ${PROFILE:-business_default}
    depends_on:
      - ollama
    ports:
      - "8003:8000"

  sim:
    build:
      context: ..
      dockerfile: services/sim/Dockerfile
    env_file:
      - ../.env
    ports:
      - "8004:8000"

  router:
    build:
      context: ..
      dockerfile: services/router/Dockerfile
    env_file:
      - ../.env
    depends_on:
      - orchestrator
    ports:
      - "8005:8000"

  web:
    build:
      context: ../apps/web
    container_name: infra-web-1
    env_file:
      - ../.env
    environment:
      NEXT_PUBLIC_API_BASE: http://orchestrator:8000
      NEXT_PUBLIC_RAG_BASE: http://rag:8000
      NEXT_PUBLIC_OBSERVABILITY_BASE: http://router:8000
    depends_on:
      - orchestrator
      - rag
      - llm-api
    ports:
      - "3000:3000"
    restart: unless-stopped

volumes:
  db-data:
  minio-data:
  grafana-data:
  opensearch-data:
  ollama:
